# Правила разработки для code-ассистента

Документ содержит правила, которым должен следовать код, генерируемый ассистентом. Основаны на принципах из vision.md.

## 1. Общие принципы

- **KISS**: Пиши максимально простой код. Избегай излишних абстракций, если они не требуются прямо сейчас.
- **YAGNI**: Не добавляй функциональность «на будущее». Реализуй только то, что нужно для текущих требований.
- **Быстрая итерация**: Код должен позволять запустить проект локально за несколько минут (через `make run` или аналоги).
- **Минимальные зависимости**: Используй как можно меньше внешних сервисов в прототипе. Например, хранилище in‑memory вместо Redis.

## 2. Код

- **Язык**: Python 3.11+.
- **Стиль**: Следуй PEP 8 (автоформатирование через ruff/black).
- **Асинхронность**: Все IO‑операции (бота, LLM‑запросы) выполняй через `async/await`.
- **Типизация**: Используй type hints для всех функций, аргументов и возвращаемых значений.
- **Документация**: Пиши docstring для публичных функций/классов в формате Google style. Внутри кода — минимальные комментарии, только если логика неочевидна.
- **Обработка ошибок**: Всегда обрабатывай исключения, логируй их и предоставляй fallback‑ответ пользователю.
- **Тестируемость**: Функции должны быть чистыми, где возможно. Зависимости внедряй через аргументы (Dependency Injection).

## 3. Архитектура

- **Структура проекта**: Соблюдай структуру из vision.md (см. `src/cook_assistant/` с модулями `bot.py`, `llm.py`, `config.py`, `storage.py`, `utils.py`).
- **Разделение ответственности**:
  - `bot.py` — только логика Telegram‑бота.
  - `llm.py` — клиент для работы с LLM.
  - `storage.py` — хранение контекста (in‑memory словарь).
  - `config.py` — загрузка конфигурации.
  - `utils.py` — вспомогательные функции.
- **Взаимодействие модулей**: Модули общаются через чётко определённые интерфейсы (функции, классы). Избегай циклических импортов.

## 4. Конфигурация

- **Переменные окружения**: Все чувствительные данные (токены, ключи) должны быть вынесены в переменные окружения.
- **Обязательные переменные**: `TELEGRAM_BOT_TOKEN`, `OPENROUTER_API_KEY`.
- **Опциональные переменные**: Задавай разумные значения по умолчанию (например, `LLM_MODEL="gpt-3.5-turbo"`, `MAX_HISTORY_LENGTH=10`).
- **Валидация**: При старте приложения проверяй наличие обязательных переменных.

## 5. Работа с LLM

- **Системный промпт**: Используй промпт из vision.md (раздел 6.1). Не меняй его без необходимости.
- **Формирование запроса**: Включай системный промпт, историю диалога (последние `MAX_HISTORY_LENGTH` сообщений) и новое сообщение пользователя.
- **Параметры LLM**:
  - Модель: `gpt-3.5-turbo` (или из конфига).
  - Температура: 0.7.
  - Максимальное количество токенов: 1000.
- **Ограничение истории**: При превышении лимита токенов обрезай историю, сохраняя последние сообщения.
- **Обработка ошибок LLM**: Таймаут 30 секунд, до 2 попыток при сетевых сбоях. При неудаче — fallback‑ответ: «Извините, сейчас не могу ответить. Попробуйте позже.»

## 6. Логирование

- **Используй стандартный модуль `logging`**.
- **Уровень логирования**: Задаётся переменной `LOG_LEVEL` (по умолчанию `INFO`).
- **Формат логов**: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`.
- **Что логировать**:
  - Запуск/остановку бота.
  - Входящие сообщения (chat_id, текст).
  - Запросы к LLM (время выполнения, статус).
  - Ошибки (исключения с traceback).
  - Очистку контекста.

## 7. Git и репозиторий

- **`.gitignore`**: Исключай `*.pyc`, `__pycache__`, `.env`, `*.log`, виртуальные окружения.
- **Коммиты**: Маленькие, атомарные коммиты с понятными сообщениями.
- **Ветки**: Для новой функциональности создавай feature‑ветку.

## 8. Деплой (опционально)

- **Docker**: Если нужен контейнер, используй многоступенчатую сборку с uv.
- **Makefile**: Предоставь команды `make run`, `make test`, `make lint`.

---

_Создано на основе vision.md.  
Дата актуализации: 2025‑12‑06_
