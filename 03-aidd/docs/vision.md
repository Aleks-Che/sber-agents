# Техническое видение: Кулинарный помощник в Telegram

## 1. Технологии

- **Язык программирования**: Python 3.11+
- **Менеджер зависимостей и окружения**: uv
- **Фреймворк для Telegram бота**: aiogram 3.x (polling)
- **Клиент для LLM**: openai (с настройкой base_url для OpenRouter)
- **Хранение контекста**: in‑memory словарь (для прототипа), с возможностью перехода на Redis
- **Конфигурация**: python‑dotenv
- **Логирование**: стандартный модуль logging
- **Сборка и задачи**: Makefile
- **Контейнеризация**: Docker (опционально, для деплоя)
- **Тестирование**: pytest (опционально)

## 2. Принцип разработки

- **KISS (Keep It Simple, Stupid)**: максимально простая реализация, без излишних абстракций.
- **YAGNI (You Ain’t Gonna Need It)**: не добавлять функциональность «на будущее», только то, что нужно сейчас.
- **Минимальная зависимость от внешних сервисов**: на этапе прототипа используем in‑memory хранилище вместо Redis.
- **Быстрая итерация**: возможность запустить бота локально за несколько минут.
- **Конфигурация через окружение**: все чувствительные данные (токены, ключи) вынесены в переменные окружения.
- **Асинхронная архитектура**: использование async/await для эффективной работы с IO.
- **Документация кода**: минимум, но достаточно для понимания.

## 3. Структура проекта

```
cook‑assistant/
├── .env.example
├── .gitignore
├── Makefile
├── pyproject.toml
├── README.md
├── src/
│   └── cook_assistant/
│       ├── __init__.py
│       ├── bot.py          # основной код бота
│       ├── llm.py          # клиент для LLM
│       ├── config.py       # загрузка конфигурации
│       ├── storage.py      # хранение контекста
│       └── utils.py        # вспомогательные функции
├── docs/
│   ├── idea.md
│   └── vision.md
└── (tests/ – может быть добавлен позже)
```

## 4. Архитектура проекта

- **Telegram Bot** (aiogram) – обработчик входящих сообщений и команд.
- **LLM Client** (openai) – отправка запросов к OpenRouter.
- **Context Storage** – in‑memory словарь для хранения истории диалога по chat_id.
- **Prompt Builder** – формирование системного промпта и истории.
- **Configuration Manager** – загрузка переменных окружения.

**Взаимодействие**:

1. Пользователь отправляет сообщение.
2. Бот извлекает историю диалога из хранилища.
3. Prompt Builder формирует полный промпт (системный + история + новое сообщение).
4. LLM Client отправляет промпт в OpenRouter и получает ответ.
5. Бот сохраняет ответ в историю и отправляет его пользователю.

## 5. Модель данных

### 5.1. DialogContext

Хранит историю сообщений для конкретного чата.

```python
{
    "chat_id": int,
    "messages": [
        {"role": "system"|"user"|"assistant", "content": str, "timestamp": datetime},
        ...
    ],
    "created_at": datetime,
    "updated_at": datetime
}
```

На этапе прототипа используется упрощённая версия: `{chat_id: list[messages]}`.

### 5.2. UserSettings (опционально)

Может хранить предпочтения пользователя (язык, диетические ограничения). Пока не реализуется.

### 5.3. Config

Параметры приложения, загружаемые из переменных окружения:

- `TELEGRAM_BOT_TOKEN`
- `OPENROUTER_API_KEY`
- `OPENROUTER_BASE_URL` (опционально)
- `LLM_MODEL` (по умолчанию "gpt‑3.5‑turbo")
- `MAX_HISTORY_LENGTH`
- `LOG_LEVEL`

## 6. Работа с LLM

### 6.1. Системный промпт

```
Ты — Кулинарный помощник, эксперт в области кулинарии, питания и гастрономии. Твоя задача — помогать пользователям с любыми вопросами, связанными с приготовлением пищи.

Ты должен:
- Давать чёткие, практичные советы и рецепты.
- Учитывать диетические ограничения (вегетарианство, аллергии, диеты).
- Предлагать замены ингредиентов, если чего‑то нет под рукой.
- Объяснять шаги приготовления простым языком.
- Поддерживать дружелюбный, мотивирующий тон.
- Избегать вредных или опасных рекомендаций.
- Если вопрос не по кулинарии, вежливо направлять разговор в соответствующее русло.

Формат ответов: текст с эмодзи для наглядности, списки, где уместно.
```

### 6.2. Формирование промпта

- Системный промпт добавляется в начало каждого диалога.
- История диалога (последние `MAX_HISTORY_LENGTH` сообщений) включается в запрос.
- Новое сообщение пользователя добавляется в конец.

### 6.3. Параметры LLM

- **Модель**: `gpt‑3.5‑turbo` (или другая, заданная в конфиге).
- **Температура**: 0.7 (баланс между креативностью и предсказуемостью).
- **Максимальное количество токенов**: 1000.
- **Стриминг**: не используется на первом этапе.

### 6.4. Обработка ошибок

- Таймаут запроса: 30 секунд.
- Повтор при сетевых сбоях (максимум 2 попытки).
- Fallback‑ответ при неудаче: «Извините, сейчас не могу ответить. Попробуйте позже.»

### 6.5. Лимит токенов

При превышении лимита история обрезается с сохранением последних сообщений.

## 7. Сценарии работы

### 7.1. Старт бота

- **Команда**: `/start`
- **Действие**: приветственное сообщение с кратким описанием возможностей.

### 7.2. Обычный диалог

- Пользователь отправляет текстовое сообщение.
- Бот формирует промпт, обращается к LLM и возвращает ответ.
- История диалога обновляется.

### 7.3. Справка

- **Команда**: `/help`
- **Действие**: список команд и примеры запросов.

### 7.4. Поиск рецепта

- **Команда**: `/recipe <запрос>`
- **Действие**: LLM получает специализированный промпт для поиска рецепта.

### 7.5. Сброс контекста

- **Команда**: `/reset`
- **Действие**: очистка истории диалога для текущего чата.

### 7.6. Обработка ошибок

- Если LLM недоступна, пользователь получает понятное сообщение об ошибке.
- Критические ошибки логируются.

## 8. Подход к конфигурированию

- Все настройки вынесены в переменные окружения.
- Файл `.env.example` содержит примеры переменных.
- При запуске конфигурация загружается через `python‑dotenv` и валидируется.
- Обязательные переменные:
  - `TELEGRAM_BOT_TOKEN`
  - `OPENROUTER_API_KEY`
- Опциональные переменные имеют разумные значения по умолчанию.

## 9. Подход к логгированию

- Используется стандартный модуль `logging`.
- Уровень логирования задаётся переменной `LOG_LEVEL` (по умолчанию `INFO`).
- Логи выводятся в консоль в формате:
  ```
  %(asctime)s - %(name)s - %(levelname)s - %(message)s
  ```
- Опционально можно добавить вывод в файл (например, `bot.log`).
- Логируются:
  - Запуск и остановка бота.
  - Входящие сообщения (chat_id, текст).
  - Запросы к LLM (время выполнения, статус).
  - Ошибки (исключения).
  - Очистка контекста.

---

_Документ составлен на основе идеи «Кулинарный помощник» (docs/idea.md).  
Дата создания: 2025‑12‑06_
